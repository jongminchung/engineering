[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File /fluent-bit/etc/parsers.conf

    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020

    # ES 단절/재시작 대비: output chunk를 디스크에 저장
    storage.path              /fluent-bit/state/storage
    storage.sync              normal
    storage.checksum          off
    storage.max_chunks_up     128
    storage.backlog.mem_limit 64M

[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*.log
    Tag               docker.*
    Parser            docker_json

    # 필수 권장: 입력 오프셋(어디까지 읽었는지) 저장
    DB                /fluent-bit/state/tail-containers.db
    DB.sync           normal

    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  5

    # 필수 권장: 전송 실패 chunk를 filesystem storage로 밀어넣기
    storage.type      filesystem

[FILTER]
    Name    record_modifier
    Match   docker.*
    Record  host ${HOSTNAME}

[OUTPUT]
    Name            es
    Match           docker.*
    Host            ${ES_HOST}
    Port            ${ES_PORT}
    HTTP_Scheme     ${ES_SCHEME}

    Logstash_Format On
    Logstash_Prefix ${ES_INDEX_PREFIX}
    Suppress_Type_Name On

    # ES 단절 시 계속 재시도
    Retry_Limit     False

    Workers         2
