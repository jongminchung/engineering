# RFC 첨부 C: 운영 절차/복구 플레이북

## 목적

- 장애 상황에서 파일 감사로그 유실을 최소화하기 위한 표준 절차 제공.
- 각 안별로 우선 대응/복구 순서를 명확히 정의.

## 공통 운영 절차

### 정상 운영 점검 (일일)

- 스토리지 사용률 임계치 확인(예: 80%, 90%).
- fluent-bit 상태(에러 로그, 재시도 횟수) 확인.
- ES 전송 지연/실패율 확인.
- 파일 로테이션 및 보관 정책 정상 적용 확인.

### 장애 공통 대응

- 1차 대응: 로그 유실 방지(파일 저장 경로 확보) > 2차 대응: 전송 복구.
- 장애 발생 시점/영향 범위 기록(타임라인 유지).
- 복구 후 재전송/재처리 여부를 반드시 검토.

## 안 1) journald -> fluent-bit -> Proxy(파일 + ES)

### 장애: ES 전송 실패

- 증상: ES output 에러/재시도 로그 증가, ES 응답 지연.
- 즉시 조치:
  - Proxy 파일 저장 정상 여부 확인(로컬 파일 계속 생성되는지 확인).
  - ES 장애 복구 전까지 Proxy 스토리지 여유 용량 확보.
- 복구 절차:
  - ES 복구 후 Proxy에서 재전송 정책 실행.
  - 재전송 완료 후 ES 인덱스 적재량 검증.

### 장애: Proxy 다운/스토리지 장애

- 증상: forward 입력 실패, 파일 생성 중단.
- 즉시 조치:
  - fluent-bit edge에서 파일 임시 버퍼(가능 시) 활성화.
  - Proxy 재기동 또는 스토리지 마운트 복구.
- 복구 절차:
  - Proxy 정상화 후 forward 재연결 확인.
  - 장애 시간대 로그 유실 여부 점검.

### 장애: fluent-bit edge 다운

- 증상: journald 수집 중단, forward 전송 중단.
- 즉시 조치:
  - journald 보존 정책 확인(임시 버퍼 확보).
  - fluent-bit edge 재기동.
- 복구 절차:
  - 재기동 후 backlog 전송 여부 확인.
  - 장애 시간대 로그 샘플링 검증.

## 안 2) app file -> filebeat -> ES (+ 중앙 스토리지)

### 장애: ES 전송 실패

- 증상: filebeat output 에러/재시도 증가.
- 즉시 조치:
  - 파일 로테이션 중단 여부 확인(파일은 계속 쌓이므로 스토리지 여유 확인).
- 복구 절차:
  - ES 복구 후 filebeat 재전송 상태 확인.
  - 필요 시 filebeat registry 점검 및 재처리.

### 장애: 중앙 스토리지 업로드 실패

- 증상: 업로드 실패 로그 증가, 중앙 스토리지 파일 누락.
- 즉시 조치:
  - 로컬 파일 보관 기간 임시 연장.
  - 업로드 재시도 큐 점검.
- 복구 절차:
  - 업로드 재개 후 누락 파일 재전송.
  - 중앙 스토리지 보관 성공 여부 검증.

### 장애: 앱 로그 파일 로테이션 실패

- 증상: 파일 크기 비정상 증가, filebeat 수집 지연.
- 즉시 조치:
  - 로테이션 설정 확인 및 즉시 적용.
- 복구 절차:
  - filebeat harvest 상태 확인.
  - 로테이션 이후 로그 유실 여부 샘플링.

## 안 3) journald -> fluent-bit -> ES + journald 파일 보관

### 장애: ES 전송 실패

- 증상: fluent-bit output 에러/재시도 증가.
- 즉시 조치:
  - journald 보존 정책으로 버퍼 유지 시간 확인.
- 복구 절차:
  - ES 복구 후 재전송 확인.
  - 필요 시 journald export 재실행.

### 장애: journald export/forward 실패

- 증상: 중앙 스토리지 파일 누락, export 스케줄 실패.
- 즉시 조치:
  - export 스크립트 재실행.
  - journald 로컬 보존 기간 확인.
- 복구 절차:
  - 누락 구간 재export.
  - 중앙 스토리지 무결성 검증.

### 장애: journald 저장 공간 부족

- 증상: journald 로그 누락, storage 경고.
- 즉시 조치:
  - 임시 보관 정책 상향 또는 스토리지 확장.
- 복구 절차:
  - 정상화 후 export 재수행.
  - 누락 여부 샘플링 점검.
